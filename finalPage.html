<html>
<body>
  <head>

    <title>Bootstrap Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
  <!DOCTYPE html>
</head>  

<html>
  



<div id = "div1"> </div>
  <input type="hidden" id="val" name="val" value="1">
  <div id = "removeButton">
<center><input   id="button1" onclick = "display2()"  type="submit" value="Return to Purchase"/></center>
</div>


<script>
  
window.sessionStorage
  

//loads ajax on page start
$(function(){

////////
//alert("in fiunction");
loadData();

////////
//  loadajax();
});


      //pressed return to purchase from template2
        function display2(){

        var querystring = "";
        alert("button1");
        let keys = Object.keys(sessionStorage);

      
        var counter = -1;
        var array = [];
        for(let key of keys) {


          if(key == "keywords")
          {
            counter++;
            alert("keywords");
           
            var item = sessionStorage.getItem(key);
            
            //item = item.slice(2);
			      //item = item.substring(0, item.length - 2);
            array = JSON.parse(item);
           // alert(array);
            //alert(array[0]);
            //alert(array.length);

            for(var i = 0; i<array.length ; i++)
            {
            
              querystring += "var=" + array[i] + "&";
            }

            alert(querystring);
            //alert(item);

          }
          else if(key == "session_userID")
          {

          }
          else
          {
            var item = sessionStorage.getItem(key);
            querystring += "id=" + key + "&quant=" + item + "&";
          } 

        }

        //document.getElementById(removeMe).display = "";


        var url = "http://localhost:8080/display2";
        //var queryString = "user_name=jerry&password=666666&user_name=marry&password=11111";



                    $.ajax({
                    type:"GET",
                    url:url,
                    data:querystring,
                    async:false,
                    success: function (result) {

                      ///alert("result");
                      //alert(result);


                    var retVals = [];
                    
                    retVals = deriveKeywordFromResult(result);
                    
                    //final keyword
                    var item1 = retVals[0];  
                    //html with keyword removed
                    var ourNewWord = retVals[1]; 
                    var item = retVals[2];
                    alert("test");
                    //alert(array[0]);
                    alert(ourNewWord);
                    
                    
                      document.getElementById('removeButton').innerHTML   = "";

                      //hack : i.e  ["apple3"] dispalyed above yellow when these two lines are not altered
                      //var val1 = '["' + array[counter] +  '"]';

                      //ourNewWord = ourNewWord.replaceAll(val1 , '');

                      //retVals = deriveKeywordFromResult(ourNewWord);

                      //document.getElementById('removeMe').innerHTML   = retVals[1];
                      
                      


                      for(var i = 0 ; i < array.length ; i++)
                      {
                        ////

                        //hack : i.e  ["apple3"] dispalyed above yellow when these four lines are not altered
                        var val1 = '["' + array[i] +  '"]';

                        ourNewWord = ourNewWord.replace(val1 , '');

                        retVals = deriveKeywordFromResult(ourNewWord);

                        document.getElementById('removeMe').innerHTML   = retVals[1];


                        /////


                        var result1a = "<a href='#" + array[i] + "'>" + array[i] + "</a><br>";
                        document.getElementById('linksHere').innerHTML   += result1a;
                      }




                   
                    }
                });




      
    };



//checkout button pressed, so is here!
//data is here by sessionstorage
//send it to purge which calls template with data
function loadData() {
  
 //alert("))))))))))))))))))))))))))"); 
  //alert("stringA");
//alert(queryString);

 var string = "";
//////////////////////

let keys = Object.keys(sessionStorage);
var var1 = "hasntBeenHere";
for(let key of keys) {


  //alert("keys here");
  //alert(key);
  if(key == "session_userID")
  {
    continue;
  }
  else if(key == "keywords")
  {
		continue;
	}
  
  //check for not an integer

  var item = sessionStorage.getItem(key);
  //alert("item");
  //alert(item);
  string =  string + "id=" + key + "&quant=" + item + "&";

  
  var1 = "hasBeenHere";
  
}

if(var1 == "hasntBeenHere")
  {
    //alert("no!");
    window.location.href = "index.html";
    //return(1);
  }

//goes backwards and last entered writes over
var queryString = string.substring(0, string.length-1);

//alert("stringB");
alert(queryString);

var url = "http://localhost:8080/template2";
//var queryString = "user_name=jerry&password=666666&user_name=marry&password=11111";



                    $.ajax({
                    type:"GET",
                    url:url,
                    data:queryString,
                    async:false,
                    success: function (data1) {

                      alert(data1);
                      
                      $('#div1').html(data1);
                   
                    }
                });
}
  
  
function deriveKeywordFromResult(result)
{

				
				var item = "";
				var item1 = "";
				var ourNewWord = "";
				item = result.match("\\[.*]");
				ourNewWord = result.replaceAll(item, '');
				//alert(ourNewWord);
				//var x = typeof(item);
				item1 = JSON.stringify(item);
				item1 = item1.slice(5);
				item1 = item1.substring(0, item1.length - 5);
				

return [item1, ourNewWord, item];				
}
  </script>



</body>
</html>